name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  generate-build-test:
    runs-on: macos-15

    env:
      SCHEME_NAME: "WrapKit"
      IOS_VERSION: "18.5"
      LATEST_IOS_VERSION: "26.1"

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # Install tools
      # -----------------------------
      - name: Install Tools
        run: |
          brew update
          brew install sourcery tuist swiftgen swiftlint

      # -----------------------------
      # Generate project
      # -----------------------------
      - name: Generate Project
        run: make project

      # -----------------------------
      # List simulators (debug)
      # -----------------------------
      - name: List Simulators
        run: |
          xcrun simctl list devices available

      # -----------------------------
      # Reset simulators (IMPORTANT)
      # -----------------------------
      - name: Reset Simulators
        run: |
          xcrun simctl shutdown all || true
          xcrun simctl erase all || true

      # -----------------------------
      # Resolve Simulator UDIDs
      # -----------------------------
      - name: Resolve Simulator UDIDs
        run: |
          set -e

          echo "ðŸ” Searching for iOS ${IOS_VERSION} simulator..."

          IOS_SIM_ID=$(xcrun simctl list devices available | \
            grep -E "iPhone .* \(${IOS_VERSION}" | \
            head -n 1 | \
            sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$IOS_SIM_ID" ]; then
            echo "âŒ No iPhone simulator found for iOS ${IOS_VERSION}"
            xcrun simctl list devices available
            exit 1
          fi

          echo "IOS_SIM_ID=$IOS_SIM_ID" >> $GITHUB_ENV
          echo "âœ… Using simulator UDID: $IOS_SIM_ID"


          echo "ðŸ” Searching for latest iOS ${LATEST_IOS_VERSION} simulator..."

          LATEST_IOS_SIM_ID=$(xcrun simctl list devices available | \
            grep -E "iPhone .* \(${LATEST_IOS_VERSION}" | \
            head -n 1 | \
            sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$LATEST_IOS_SIM_ID" ]; then
            echo "âŒ No iPhone simulator found for iOS ${LATEST_IOS_VERSION}"
            xcrun simctl list devices available
            exit 1
          fi

          echo "LATEST_IOS_SIM_ID=$LATEST_IOS_SIM_ID" >> $GITHUB_ENV
          echo "âœ… Using simulator UDID: $LATEST_IOS_SIM_ID"

      # -----------------------------
      # Build & Test (iOS stable)
      # -----------------------------
      - name: Build & Test iOS ${{ env.IOS_VERSION }}
        run: |
          xcodebuild clean build test \
            -workspace $SCHEME_NAME.xcworkspace \
            -scheme $SCHEME_NAME \
            -destination "id=$IOS_SIM_ID" \
            -resultBundlePath TestResults-iOS-${IOS_VERSION}

      # -----------------------------
      # Build & Test (Latest iOS)
      # -----------------------------
      - name: Build & Test iOS ${{ env.LATEST_IOS_VERSION }}
        run: |
          xcodebuild clean build test \
            -workspace $SCHEME_NAME.xcworkspace \
            -scheme $SCHEME_NAME \
            -destination "id=$LATEST_IOS_SIM_ID" \
            -resultBundlePath TestResults-iOS-${LATEST_IOS_VERSION}

      # -----------------------------
      # Upload test artifacts
      # -----------------------------
      - name: Upload Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-test-results
          path: |
            TestResults-iOS-${{ env.IOS_VERSION }}
            TestResults-iOS-${{ env.LATEST_IOS_VERSION }}
          retention-days: 2
