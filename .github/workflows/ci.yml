name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  generate-build-test:
    runs-on: macos-latest # https://github.com/actions/runner-images/blob/main/images/macos/macos-26-arm64-Readme.md
    env:
      SCHEME_NAME: "WrapKit"
      IOS_VERSION: "18.4"
      LATEST_IOS_VERSION: "26.0.1"
    steps:
      # -----------------------------
      # Checkout Code
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # Install Tools
      # -----------------------------
      - name: Install Tools
        run: |
          brew install sourcery
          brew install tuist
          brew install swiftgen
          brew install swiftlint

      # -----------------------------
      # Generate / Build
      # -----------------------------
      - name: Run Makefile for Build
        run: make project

      # -----------------------------
      # Ensure iOS Simulators
      # -----------------------------
      - name: Ensure iOS Simulators
        run: |
          xcrun simctl list runtimes

      # -----------------------------
      # Run Tests
      # List of available os in docs https://github.com/actions/runner-images/blob/main/images/macos/macos-26-arm64-Readme.md 
      # -----------------------------
      - name: Run Tests on $IOS_VERSION
        run: |
          xcodebuild clean build test -workspace $SCHEME_NAME.xcworkspace -scheme $SCHEME_NAME -destination "platform=iOS Simulator,name=iPhone 16 Pro,OS=$IOS_VERSION"
      - name: Run Tests on $LATEST_IOS_VERSION
        run: |
          xcodebuild clean build test -workspace $SCHEME_NAME.xcworkspace -scheme $SCHEME_NAME -destination "platform=iOS Simulator,name=iPhone 17 Pro,OS=$LATEST_IOS_VERSION"

