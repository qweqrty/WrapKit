name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  generate-build-test:
    runs-on: macos-15

    env:
      SCHEME_NAME: "WrapKit"
      IOS_VERSION: "18.5"
      LATEST_IOS_VERSION: "26.1"

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # Install tools
      # -----------------------------
      - name: Install Tools
        run: |
          brew update
          brew install sourcery tuist swiftgen swiftlint

      # -----------------------------
      # Generate project
      # -----------------------------
      - name: Generate Project
        run: make project

      # -----------------------------
      # List simulators (debug)
      # -----------------------------
      - name: List Simulators
        run: |
          xcrun simctl list devices available

      # -----------------------------
      # Reset simulators (IMPORTANT)
      # -----------------------------
      - name: Reset Simulators
        run: |
          xcrun simctl shutdown all || true
          xcrun simctl erase all || true

      # -----------------------------
      # Resolve Simulator UDIDs
      # -----------------------------
      - name: Resolve Simulator UDIDs
        run: |
          set -e

          find_simulator() {
            local IOS_VERSION="$1"

            xcrun simctl list devices available | \
            awk -v ios="iOS ${IOS_VERSION}" '
              $0 ~ "^-- " ios " --" {found=1; next}
              found && $0 ~ "iPhone" {
                match($0, /\(([A-F0-9-]+)\)/, arr)
                print arr[1]
                exit
              }
              found && $0 ~ "^--" {found=0}
            '
          }

          echo "ðŸ” Searching for iOS ${IOS_VERSION} iPhone simulator..."
          IOS_SIM_ID=$(find_simulator "$IOS_VERSION")

          if [ -z "$IOS_SIM_ID" ]; then
            echo "âŒ No iPhone simulator found for iOS ${IOS_VERSION}"
            exit 1
          fi

          echo "IOS_SIM_ID=$IOS_SIM_ID" >> $GITHUB_ENV
          echo "âœ… Using iOS ${IOS_VERSION} simulator: $IOS_SIM_ID"

          echo "ðŸ” Searching for latest iOS ${LATEST_IOS_VERSION} iPhone simulator..."
          LATEST_IOS_SIM_ID=$(find_simulator "$LATEST_IOS_VERSION")

          if [ -z "$LATEST_IOS_SIM_ID" ]; then
            echo "âŒ No iPhone simulator found for iOS ${LATEST_IOS_VERSION}"
            exit 1
          fi

          echo "LATEST_IOS_SIM_ID=$LATEST_IOS_SIM_ID" >> $GITHUB_ENV
          echo "âœ… Using iOS ${LATEST_IOS_VERSION} simulator: $LATEST_IOS_SIM_ID"


      # -----------------------------
      # Build & Test (iOS stable)
      # -----------------------------
      - name: Run Tests on iOS
        run: |
          xcodebuild clean build test \
            -workspace $SCHEME_NAME.xcworkspace \
            -scheme $SCHEME_NAME \
            -destination "platform=iOS Simulator,id=$IOS_SIM_ID"

      # -----------------------------
      # Build & Test (Latest iOS)
      # -----------------------------
      - name: Run Tests on Latest iOS
        run: |
          xcodebuild clean build test \
            -workspace $SCHEME_NAME.xcworkspace \
            -scheme $SCHEME_NAME \
            -destination "platform=iOS Simulator,id=$LATEST_IOS_SIM_ID"


      # -----------------------------
      # Upload test artifacts
      # -----------------------------
      - name: Upload Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-test-results
          path: |
            TestResults-iOS-${{ env.IOS_VERSION }}
            TestResults-iOS-${{ env.LATEST_IOS_VERSION }}
          retention-days: 2
