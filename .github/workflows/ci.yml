name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  generate-build-test:
    runs-on: macos-latest

    steps:
      # -----------------------------
      # Checkout Code
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # Cache Tools
      # -----------------------------
      - name: Cache Tuist
        uses: actions/cache@v4
        with:
          path: ~/.tuist
          key: ${{ runner.os }}-tuist-latest
          restore-keys: ${{ runner.os }}-tuist-

      - name: Cache SwiftGen
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew/swiftgen--*
            ~/Library/Caches/Homebrew/downloads/*--swiftgen-*
          key: ${{ runner.os }}-homebrew-swiftgen-latest
          restore-keys: ${{ runner.os }}-homebrew-swiftgen-

      - name: Cache Sourcery
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew/sourcery--*
            ~/Library/Caches/Homebrew/downloads/*--sourcery-*
          key: ${{ runner.os }}-homebrew-sourcery-2.2.6
          restore-keys: ${{ runner.os }}-homebrew-sourcery-

      - name: Cache SwiftLint
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew/swiftlint--*
            ~/Library/Caches/Homebrew/downloads/*--swiftlint-*
          key: ${{ runner.os }}-homebrew-swiftlint-latest
          restore-keys: ${{ runner.os }}-homebrew-swiftlint-

      # -----------------------------
      # Install Tools
      # -----------------------------
      - name: Install Tools
        run: |
          brew install sourcery
          brew install tuist
          brew install swiftgen
          brew install swiftlint

      # -----------------------------
      # Generate / Build
      # -----------------------------
      - name: Run Makefile for Build
        run: make project

      # -----------------------------
      # Ensure iOS Simulators
      # -----------------------------
      - name: Ensure iOS Simulators
        run: |
          xcodebuild -downloadPlatform iOS
          xcrun simctl list runtimes

      # -----------------------------
      # Run Tests
      # -----------------------------
      - name: Run Tests on iOS >= 18.3
        run: |
          # Pick first available simulator >= 18.3
          DEVICE_18=$(xcrun simctl list devices available | grep "iOS 18" | grep -v unavailable | head -n1 | awk -F '[()]' '{print $2}')
          echo "Using simulator $DEVICE_18 for iOS >= 18.3"
          xcodebuild clean build test \
            -workspace WrapKit.xcworkspace \
            -scheme WrapKit \
            -destination "id=$DEVICE_18"

      - name: Run Tests on iOS >= 26.1
        run: |
          # Pick first available simulator >= 26.1
          DEVICE_26=$(xcrun simctl list devices available | grep "iOS 26" | grep -v unavailable | head -n1 | awk -F '[()]' '{print $2}')
          echo "Using simulator $DEVICE_26 for iOS >= 26.1"
          xcodebuild clean build test \
            -workspace WrapKit.xcworkspace \
            -scheme WrapKit \
            -destination "id=$DEVICE_26"
